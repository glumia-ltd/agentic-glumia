# AI Project Agent

A stateful, blueprint-driven AI agent that:

- **Curates** inputs → **Designs** a plan → **Implements** tasks → **Reviews** → **Ships**  
- Executes at explicit **states** with **hooked prompts & tools**  
- Integrates **GitHub** (issues/branches/PRs/commits), optional **Vercel** deploys  
- CI gating with **GitHub Actions** and **branch protection**  
- Optional workflows: **Release PRs**, **Auto-label**, **Auto-assign**

---

## Contents

- [Features](#features)  
- [Prerequisites](#prerequisites)  
- [Local Quickstart](#local-quickstart)  
- [Run a Blueprint](#run-a-blueprint)  
- [GitHub Setup (Repo + CI + Labels + CODEOWNERS)](#github-setup-repo--ci--labels--codeowners)  
- [Deployment](#deployment)  
  - [Vercel](#vercel)  
  - [Docker](#docker)  
  - [VPS](#vps)  
- [Release PR Workflow](#release-pr-workflow)  
- [Auto-label + Auto-assign](#auto-label--auto-assign)  
- [Project Structure](#project-structure)  
- [Troubleshooting](#troubleshooting)

---

## Features

- **State machine orchestration** with LangGraph  
- **Role prompts** per phase (Curator, Designer, Implementer, QA, Release)  
- **Tool routing** for:
  - GitHub: create branch/issue/PR and commit artifacts generated by the agent  
  - CI gates (tests), Lighthouse audit (stub), simple Vercel deploy (optional)
- **Blueprints** in YAML define phases, tasks, transitions, and tool calls
- **Artifacts** saved to `run_artifacts/` for traceability
- **GitHub Actions**: tests, labeler, image publish to GHCR, auto-assign reviewers
- **Governance**: CODEOWNERS, PR template, branch protection script

---

## Prerequisites

- **Python** 3.10+  
- **Node & npm** (only if you’ll use Vercel CLI)  
- **GitHub account** + **gh CLI** (`gh auth login`)  
- OpenAI API key
- (Optional) **Docker** 24+  
- (Optional) **Vercel CLI** (`npm i -g vercel`)

> **Environment variables** you’ll likely use:
- `OPENAI_API_KEY` – required to run the agent  
- `OPENAI_MODEL` – optional (default `gpt-4o-mini`)  
- `GITHUB_TOKEN` – a PAT with `repo` scope for API operations  
- `GITHUB_OWNER` – your org/user  
- `GITHUB_REPO` – repo name  
- `VERCEL_TOKEN` – for `deploy.vercel` tool

---

## Local Quickstart

```bash
# 1) clone & enter
git clone <your-repo-url>.git
cd <repo>

# 2) Python virtualenv
python -m venv .venv
source .venv/Scripts/activate        # (Windows: .venv\Scripts\activate)

# 3) Install deps
pip install -r requirements.txt
pip install pytest

# 4) Set environment (shell or copy .env.example → .env and export)
export OPENAI_API_KEY="sk-..."
# optional:
export OPENAI_MODEL="gpt-4o-mini"

# 5) Validate example blueprint
python -m src.app validate --blueprint examples/website_redesign.yaml

# 6) Run (writes artifacts to ./run_artifacts)
python -m src.app run --blueprint examples/website_redesign.yaml
```

---

## Run a Blueprint

Two examples are included:

### 1) Website redesign (local stubs)
```bash
python -m src.app run --blueprint examples/website_redesign.yaml
```

### 2) GitHub automation demo
Creates a branch, opens an issue, commits an artifact, and opens a PR; optional Vercel deploy.

```bash
# configure repo details
export GITHUB_TOKEN=<repo-scope PAT>
export GITHUB_OWNER=<you-or-org>
export GITHUB_REPO=<repo-name>

# (optional) for deploy.vercel step
npm i -g vercel
export VERCEL_TOKEN=<vercel-token>

python -m src.app run --blueprint examples/gh_automation.yaml
```

---

## GitHub Setup (Repo + CI + Labels + CODEOWNERS)

**Create repo + push code**
```bash
gh auth login
./scripts/bootstrap_repo.sh <you-or-org> <repo> private
```

**Protect main branch (PRs + Code Owner reviews)**
```bash
./scripts/protect_main.sh <you-or-org> <repo>
# After first CI run, in Settings → Branches, add required checks:
#   "CI / test (3.10)" and "CI / test (3.11)"
```

**Seed labels** (for labeler + auto-assign)
```bash
# API way:
export GITHUB_TOKEN=<PAT>
export GITHUB_OWNER=<you-or-org>
export GITHUB_REPO=<repo>
python scripts/seed_labels.py

# or via gh CLI:
./scripts/seed_labels.sh
```

**CODEOWNERS**
```bash
# Edit codeowners.config.yaml to map folders → teams/users
python scripts/generate_codeowners.py
git add .github/CODEOWNERS && git commit -m "chore: regenerate CODEOWNERS"
```

---

## Deployment

### Vercel

Use the included `deploy.vercel` tool (optional step in `examples/gh_automation.yaml`) or deploy your repo/app as a standard Vercel project.

**Option A — Agent-triggered deploy (CLI token)**
```bash
npm i -g vercel
export VERCEL_TOKEN=<vercel-token>
python src/app.py run --blueprint examples/gh_automation.yaml
# The "ship" phase calls deploy.vercel via the tool router
```

**Option B — Manual/CI deploy**
- Install and log in locally: `vercel login`  
- From your app directory (e.g., a frontend subfolder), run `vercel --prod`  
- To make Vercel deploy part of CI, add a step that runs `vercel --prod --token ${{ secrets.VERCEL_TOKEN }}`

> Notes:
> - Ensure the folder you deploy contains a valid Vercel project (e.g., Next.js).  
> - If your agent is backend-only, you can still deploy a small static dashboard or docs.

---

### Docker

**Build a local image**
```bash
docker build -t ai-project-agent .
```

**Run locally with env + examples**
```bash
docker run --rm -it   -e OPENAI_API_KEY=$OPENAI_API_KEY   -e GITHUB_TOKEN=$GITHUB_TOKEN   -e GITHUB_OWNER=$GITHUB_OWNER   -e GITHUB_REPO=$GITHUB_REPO   -v "$PWD/examples:/app/examples"   ai-project-agent run --blueprint examples/gh_automation.yaml
```

**Publish to GHCR (via workflow)**
- `.github/workflows/release-image.yml` builds and pushes `ghcr.io/<owner>/ai-project-agent` on:
  - pushes to `main`
  - tags like `vX.Y.Z`
- Pull & run anywhere:
```bash
docker pull ghcr.io/<owner>/ai-project-agent:main
docker run --rm -it -e OPENAI_API_KEY=... ghcr.io/<owner>/ai-project-agent:main --help
```

---

### VPS

You can deploy on any Linux box (Ubuntu/Debian recommended) either **bare-metal (venv + systemd)** or **Docker**.

#### A) Bare-metal (systemd service)

1) **Create a user & install deps**
```bash
# as root
adduser agent && usermod -aG sudo agent
apt-get update && apt-get install -y python3.11 python3.11-venv git
su - agent
```

2) **Clone & set up**
```bash
git clone https://github.com/<you-or-org>/<repo>.git
cd <repo>
python3.11 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

3) **Provide env**
```bash
# /home/agent/<repo>/.env
OPENAI_API_KEY=...
OPENAI_MODEL=gpt-4o-mini
GITHUB_TOKEN=...
GITHUB_OWNER=...
GITHUB_REPO=...
```

4) **Systemd unit** `/etc/systemd/system/ai-agent.service`
```ini
[Unit]
Description=AI Project Agent
After=network.target

[Service]
User=agent
WorkingDirectory=/home/agent/<repo>
EnvironmentFile=/home/agent/<repo>/.env
ExecStart=/home/agent/<repo>/.venv/bin/python -m src.app run --blueprint examples/gh_automation.yaml
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

5) **Enable & start**
```bash
sudo systemctl daemon-reload
sudo systemctl enable ai-agent
sudo systemctl start ai-agent
sudo systemctl status ai-agent
```

> Update the `ExecStart` to whichever blueprint you want to run (or wrap with a small shell script that selects by cron/schedule).

#### B) VPS with Docker

1) **Install Docker** (on the VPS)  
2) **Run with env** (same as local Docker example):
```bash
docker run -d --restart=on-failure   --name ai-agent   -e OPENAI_API_KEY=...   -e GITHUB_TOKEN=...   -e GITHUB_OWNER=...   -e GITHUB_REPO=...   -v /opt/ai-agent/examples:/app/examples   ghcr.io/<owner>/ai-project-agent:main run --blueprint examples/gh_automation.yaml
```

> Prefer using a **tagged** image (e.g., `:v0.2.0`) in production.

---

## Release PR Workflow

- `scripts/version_bump.py` determines the next semver from commit messages (Conventional Commits).  
- `scripts/changelog_from_commits.py` prepends the latest section to `CHANGELOG.md`.  
- `.github/workflows/release-pr.yml` opens a **Release PR** with bumped `VERSION` and updated changelog.  
- After merging, create a tag `vX.Y.Z` (or wire tagging into the workflow) to trigger GHCR image publish.

---

## Auto-label + Auto-assign

- `.github/labeler.yml` + `.github/workflows/auto-label.yml` apply labels based on changed paths.  
- `.github/auto-assign-rules.yml` + `.github/workflows/auto-assign.yml` request reviewers/assignees based on labels.  
- Use `scripts/seed_labels.py` or `scripts/seed_labels.sh` to create the label set your rules reference.

---

## Project Structure

```
src/
  app.py                # CLI (validate/run)
  orchestrator.py       # Graph + tool router
  models.py             # Pydantic models
  runtime/io.py         # logs & artifact writer
  tools/
    tool_stubs.py       # doc.create, ci.run_tests, lighthouse.audit
    github_api.py       # create_branch, create_issue, commit_file, create_pr
    deploy.py           # deploy.vercel (CLI wrapper)
prompts/
  role_prompts.yaml
examples/
  website_redesign.yaml
  gh_automation.yaml
.github/
  workflows/ci.yml
  workflows/auto-label.yml
  workflows/auto-assign.yml
  workflows/release-image.yml
  workflows/release-pr.yml
  labeler.yml
  CODEOWNERS
  ISSUE_TEMPLATE/
    bug_report.yml
    feature_request.yml
scripts/
  bootstrap_repo.sh
  protect_main.sh
  seed_labels.py
  seed_labels.sh
  generate_codeowners.py
  check_codeowners.py
Dockerfile
.dockerignore
VERSION
CHANGELOG.md
```

---

## Troubleshooting

- **CI not gating merges**: ensure **Branch protection** is enabled and the CI job names are added as **required checks**.  
- **GitHub API errors**: check `GITHUB_TOKEN` scopes (`repo`), and that `GITHUB_OWNER/GITHUB_REPO` point to an existing repo you can write to.  
- **Vercel deploys**: make sure the directory you’re deploying is a valid Vercel project; confirm `VERCEL_TOKEN`.  
- **State not advancing**: inspect `run_artifacts/` outputs; verify gates/approvals in your blueprint and env/tool configuration.  
- **Docker permissions**: on VPS, ensure the user has permission to run Docker or use `sudo`.
