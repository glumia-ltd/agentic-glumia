name: Auto-assign reviewers

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review, labeled, unlabeled, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  route:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (rules only)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          sparse-checkout: |
            .github/auto-assign-rules.yml
          sparse-checkout-cone-mode: false

      - name: Load rules and apply
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');

            function uniq(a) { return [...new Set(a.filter(Boolean))]; }

            // Read rules
            const rulesPath = '.github/auto-assign-rules.yml';
            if (!fs.existsSync(rulesPath)) {
              core.info('No auto-assign rules found.');
              return;
            }
            const rules = yaml.load(fs.readFileSync(rulesPath, 'utf8'))?.rules || {};
            const labels = context.payload.pull_request.labels.map(l => l.name);

            let reviewers = [];
            let assignees = [];
            for (const label of labels) {
              const r = rules[label];
              if (!r) continue;
              reviewers = reviewers.concat(r.reviewers || []);
              assignees = assignees.concat(r.assignees || []);
            }
            reviewers = uniq(reviewers);
            assignees = uniq(assignees);

            // Apply reviewers/assignees if any
            if (reviewers.length) {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: reviewers.filter(x => !x.includes('/')),         // users only
                team_reviewers: reviewers.filter(x => x.includes('/')).map(s => s.split('/')[1]) // org/team
              });
            }
            if (assignees.length) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                assignees
              });
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-label (optional nudge)
        if: ${{ github.event.action == 'opened' }}
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
      - name: Install js-yaml
        run: npm i js-yaml
